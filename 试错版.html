<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>排球站位记录工具</title>
    <style>
        :root {
            --player-color: #1890ff;
            --court-color: #ff7d00;
            --center-line-color: #ffffff;
            --text-color: #333333;
            --light-text: #ffffff;
            --panel-bg: #ffffff;
            --panel-border: #e0e0e0;
            --button-primary: #4CAF50;
            --button-danger: #f5222d;
            --button-warning: #faad14;
            --button-info: #13c2c2;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            background-color: #f8f9fa;
            color: var(--text-color);
            line-height: 1.5;
            -webkit-text-size-adjust: 100%;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .panel {
            border: 1px solid var(--panel-border);
            padding: 15px;
            border-radius: 6px;
            background-color: var(--panel-bg);
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            animation: fadeIn 0.4s ease-out;
        }
        
        .setup-panel {
            display: block;
        }
        
        .game-panel, .history-panel {
            display: none;
        }
        
        h3 {
            color: var(--text-color);
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
            text-align: center;
        }
        
        h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            text-align: center;
        }
        
        .team-setup {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            gap: 10px;
        }
        
        .team {
            width: 48%;
            padding: 10px;
            background-color: rgba(248, 249, 250, 0.8);
            border-radius: 5px;
        }
        
        .player-input-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 10px;
        }
        
        .player-row {
            display: flex;
            justify-content: center;
            gap: 8px;
        }
        
        .player-input {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }
        
        .player-input input {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            width: 55px;
            font-size: 14px;
            transition: border 0.3s;
        }
        
        .player-input input:focus {
            border-color: var(--player-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }
        
        .position-label {
            font-size: 11px;
            color: #666;
            text-align: center;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        /* 核心修改：放大按钮尺寸但不改变整体布局 */
        button {
            padding: 12px 18px; /* 增加内边距放大按钮 */
            color: white;
            border: none;
            border-radius: 6px; /* 略微增加圆角更易点击 */
            cursor: pointer;
            font-size: 15px; /* 放大字体 */
            margin: 3px;
            transition: all 0.3s;
            font-weight: 500;
            min-width: 100px; /* 增加最小宽度 */
        }
        
        button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); /* 增强悬停效果 */
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .volleyball-court {
            width: 900px;
            height: 200px;
            background-color: var(--court-color);
            position: relative;
            border: 3px solid #333;
            margin: 10px 0;
            display: flex;
            overflow: hidden;
            border-radius: 5px;
            margin: 0 auto;
        }
        
        .court-line {
            position: absolute;
        }
        
        .center-line {
            width: 6px;
            height: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--center-line-color);
        }
        
        .team-area {
            position: relative;
            width: 50%;
            height: 100%;
        }
        
        .position {
            position: absolute;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--light-text);
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            background-color: var(--player-color);
        }
        
        .position:hover {
            transform: scale(1.04);
        }
        
        .position-number {
            position: absolute;
            top: -16px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: var(--light-text);
            background-color: rgba(0,0,0,0.6);
            padding: 1px 5px;
            border-radius: 8px;
            font-weight: 500;
            min-width: 30px;
            text-align: center;
        }
        
        .team-a-area .pos-4 { top: 15%; right: 25%; }
        .team-a-area .pos-3 { top: 45%; right: 25%; }
        .team-a-area .pos-2 { top: 75%; right: 25%; }
        .team-a-area .pos-5 { top: 15%; left: 25%; }
        .team-a-area .pos-6 { top: 45%; left: 25%; }
        .team-a-area .pos-1 { top: 75%; left: 25%; }
        
        .team-b-area .pos-2 { top: 15%; left: 25%; }
        .team-b-area .pos-3 { top: 45%; left: 25%; }
        .team-b-area .pos-4 { top: 75%; left: 25%; }
        .team-b-area .pos-1 { top: 15%; right: 25%; }
        .team-b-area .pos-6 { top: 45%; right: 25%; }
        .team-b-area .pos-5 { top: 75%; right: 25%; }
        
        .substitutes-area {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 6px;
        }
        
        .team-substitutes {
            width: 48%;
        }
        
        .substitute-player {
            display: inline-block;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #ccc;
            color: #333;
            font-weight: bold;
            text-align: center;
            line-height: 36px;
            margin: 3px;
            border: 1px solid #999;
            font-size: 12px;
        }
        
        .substitute-title {
            font-weight: bold;
            margin-bottom: 6px;
            text-align: center;
            color: #555;
            font-size: 13px;
        }
        
        .score-display {
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            margin: 12px 0;
            color: var(--text-color);
            letter-spacing: 3px;
        }
        
        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap; /* 保持换行避免溢出 */
        }
        
        .team-a-btn, .team-b-btn {
            background-color: var(--player-color);
        }
        
        .undo-btn {
            background-color: #722ed1;
        }
        
        .return-btn {
            background-color: var(--button-info);
        }
        
        .history-btn {
            background-color: var(--button-primary);
        }
        
        .back-btn {
            background-color: var(--button-warning);
        }
        
        .pause-btn {
            background-color: var(--button-warning);
        }
        
        .continue-btn {
            background-color: var(--button-primary);
        }
        
        .substitute-btn {
            background-color: #13c2c2;
        }
        
        .serve-indicator {
            text-align: center;
            font-weight: bold;
            margin: 8px 0;
            color: var(--text-color);
            font-size: 14px;
            padding: 6px;
            background-color: rgba(255,255,255,0.8);
            border-radius: 4px;
            display: inline-block;
            margin: 8px auto;
            width: auto;
            min-width: 160px;
        }
        
        .pause-indicator {
            text-align: center;
            color: var(--button-warning);
            font-weight: bold;
            height: 20px;
            margin: 8px 0;
            font-size: 13px;
            padding: 3px;
            background-color: rgba(250, 173, 20, 0.1);
            border-radius: 3px;
        }
        
        .countdown {
            font-size: 16px;
            font-weight: bold;
            color: var(--button-danger);
            margin-left: 3px;
        }
        
        .mini-history-panel {
            margin-top: 12px;
            padding: 8px;
            border: 1px solid var(--panel-border);
            border-radius: 5px;
            max-height: 90px;
            overflow-y: auto;
            font-size: 12px;
            background-color: rgba(248, 249, 250, 0.8);
        }
        
        .full-history-panel {
            margin-top: 12px;
            padding: 10px;
            border: 1px solid var(--panel-border);
            border-radius: 5px;
            max-height: 350px;
            overflow-y: auto;
            font-size: 12px;
            background-color: rgba(248, 249, 250, 0.8);
        }
        
        .history-item {
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .serve-team {
            color: var(--button-danger);
            font-weight: bold;
            margin-left: 6px;
            font-size: 11px;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        select {
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 13px;
            margin-left: 6px;
            transition: all 0.3s;
        }
        
        select:focus {
            border-color: var(--player-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }
        
        .starting-players {
            margin-bottom: 12px;
        }
        
        .substitute-players {
            border-top: 1px solid #eee;
            padding-top: 12px;
        }
        
        .substitute-players .player-input input {
            background-color: #f8f8f8;
        }
        
        /* 保持原有响应式适配，确保在小屏幕上按钮仍可正常显示 */
        @media screen and (orientation: landscape) and (max-height: 600px) {
            .volleyball-court {
                height: 200px;
            }
            
            .position {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            .position-number {
                font-size: 9px;
                top: -14px;
            }
            
            .score-display {
                font-size: 24px;
                margin: 8px 0;
            }
            
            .control-buttons {
                gap: 6px;
                margin-bottom: 8px;
            }
            
            button {
                padding: 10px 14px; /* 小屏幕适当缩减按钮大小 */
                font-size: 14px;
                min-width: 90px;
            }
            
            .substitute-player {
                width: 32px;
                height: 32px;
                line-height: 32px;
                font-size: 11px;
            }
            
            .serve-indicator {
                font-size: 13px;
                padding: 5px;
                min-width: 140px;
            }
        }
        
        @media (max-width: 768px) {
            button {
                padding: 10px 12px;
                font-size: 14px;
                min-width: 85px;
            }
        }
        
        @media (max-width: 576px) {
            button {
                padding: 9px 10px;
                font-size: 13px;
                min-width: 80px;
            }
        }
        
        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 2px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 2px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- 原有HTML结构保持不变 -->
    <div class="container">
        <div class="panel setup-panel" id="setupPanel">
            <h2>排球站位记录工具</h2>
            
            <div class="team-setup">
                <!-- A队输入 -->
                <div class="team team-a">
                    <h3>A队队员号码</h3>
                    <div class="player-input-container">
                        <div class="starting-players">
                            <h4>首发队员</h4>
                            <div class="player-row">
                                <div class="player-input">
                                    <div class="position-label">4号位</div>
                                    <input type="text" id="a-pos4" placeholder="号码" maxlength="2">
                                </div>
                                <div class="player-input">
                                    <div class="position-label">3号位</div>
                                    <input type="text" id="a-pos3" placeholder="号码" maxlength="2">
                                </div>
                                <div class="player-input">
                                    <div class="position-label">2号位</div>
                                    <input type="text" id="a-pos2" placeholder="号码" maxlength="2">
                                </div>
                            </div>
                            <div class="player-row">
                                <div class="player-input">
                                    <div class="position-label">5号位</div>
                                    <input type="text" id="a-pos5" placeholder="号码" maxlength="2">
                                </div>
                                <div class="player-input">
                                    <div class="position-label">6号位</div>
                                    <input type="text" id="a-pos6" placeholder="号码" maxlength="2">
                                </div>
                                <div class="player-input">
                                    <div class="position-label">1号位</div>
                                    <input type="text" id="a-pos1" placeholder="号码" maxlength="2">
                                </div>
                            </div>
                        </div>
                        
                        <div class="substitute-players">
                            <h4>替补队员</h4>
                            <div class="player-row">
                                <div class="player-input">
                                    <div class="position-label">替补1</div>
                                    <input type="text" id="a-sub1" placeholder="号码" maxlength="2">
                                </div>
                                <div class="player-input">
                                    <div class="position-label">替补2</div>
                                    <input type="text" id="a-sub2" placeholder="号码" maxlength="2">
                                </div>
                                <div class="player-input">
                                    <div class="position-label">替补3</div>
                                    <input type="text" id="a-sub3" placeholder="号码" maxlength="2">
                                </div>
                            </div>
                            <div class="player-row">
                                <div class="player-input">
                                    <div class="position-label">替补4</div>
                                    <input type="text" id="a-sub4" placeholder="号码" maxlength="2">
                                </div>
                                <div class="player-input">
                                    <div class="position-label">替补5</div>
                                    <input type="text" id="a-sub5" placeholder="号码" maxlength="2">
                                </div>
                                <div class="player-input">
                                    <div class="position-label">替补6</div>
                                    <input type="text" id="a-sub6" placeholder="号码" maxlength="2">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- B队输入 -->
                <div class="team team-b">
                    <h3>B队队员号码</h3>
                    <div class="player-input-container">
                        <div class="starting-players">
                            <h4>首发队员</h4>
                            <div class="player-row">
                                <div class="player-input">
                                    <div class="position-label">4号位</div>
                                    <input type="text" id="b-pos4" placeholder="号码" maxlength="2">
                                </div>
                                <div class="player-input">
                                    <div class="position-label">3号位</div>
                                    <input type="text" id="b-pos3" placeholder="号码" maxlength="2">
                                </div>
                                <div class="player-input">
                                    <div class="position-label">2号位</div>
                                    <input type="text" id="b-pos2" placeholder="号码" maxlength="2">
                                </div>
                            </div>
                            <div class="player-row">
                                <div class="player-input">
                                    <div class="position-label">5号位</div>
                                    <input type="text" id="b-pos5" placeholder="号码" maxlength="2">
                                </div>
                                <div class="player-input">
                                    <div class="position-label">6号位</div>
                                    <input type="text" id="b-pos6" placeholder="号码" maxlength="2">
                                </div>
                                <div class="player-input">
                                    <div class="position-label">1号位</div>
                                    <input type="text" id="b-pos1" placeholder="号码" maxlength="2">
                                </div>
                            </div>
                        </div>
                        
                        <div class="substitute-players">
                            <h4>替补队员</h4>
                            <div class="player-row">
                                <div class="player-input">
                                    <div class="position-label">替补1</div>
                                    <input type="text" id="b-sub1" placeholder="号码" maxlength="2">
                                </div>
                                <div class="player-input">
                                    <div class="position-label">替补2</div>
                                    <input type="text" id="b-sub2" placeholder="号码" maxlength="2">
                                </div>
                                <div class="player-input">
                                    <div class="position-label">替补3</div>
                                    <input type="text" id="b-sub3" placeholder="号码" maxlength="2">
                                </div>
                            </div>
                            <div class="player-row">
                                <div class="player-input">
                                    <div class="position-label">替补4</div>
                                    <input type="text" id="b-sub4" placeholder="号码" maxlength="2">
                                </div>
                                <div class="player-input">
                                    <div class="position-label">替补5</div>
                                    <input type="text" id="b-sub5" placeholder="号码" maxlength="2">
                                </div>
                                <div class="player-input">
                                    <div class="position-label">替补6</div>
                                    <input type="text" id="b-sub6" placeholder="号码" maxlength="2">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin: 15px 0;">
                <label for="serveTeam">初始发球方:</label>
                <select id="serveTeam">
                    <option value="A">A队</option>
                    <option value="B">B队</option>
                </select>
            </div>
            
            <div style="text-align: center;">
                <button id="confirmBtn" style="background-color: var(--button-primary); padding: 10px 24px; font-size: 16px;">开始记录</button>
            </div>
        </div>
        
        <div class="panel game-panel" id="gamePanel">
            <div class="serve-indicator" id="serveIndicator">当前发球方: A队4号</div>
            
            <div class="pause-indicator" id="pauseIndicator"></div>
            
            <!-- 排球场 -->
            <div class="volleyball-court">
                <!-- 球场线 -->
                <div class="court-line center-line"></div>
                
                <!-- A队区域 -->
                <div class="team-area team-a-area">
                    <div class="position pos-4" data-pos="4" data-team="A">
                        <div class="position-number">4号位</div>
                        <div>4</div>
                    </div>
                    <div class="position pos-3" data-pos="3" data-team="A">
                        <div class="position-number">3号位</div>
                        <div>3</div>
                    </div>
                    <div class="position pos-2" data-pos="2" data-team="A">
                        <div class="position-number">2号位</div>
                        <div>2</div>
                    </div>
                    <div class="position pos-5" data-pos="5" data-team="A">
                        <div class="position-number">5号位</div>
                        <div>5</div>
                    </div>
                    <div class="position pos-6" data-pos="6" data-team="A">
                        <div class="position-number">6号位</div>
                        <div>6</div>
                    </div>
                    <div class="position pos-1" data-pos="1" data-team="A">
                        <div class="position-number">1号位</div>
                        <div>1</div>
                    </div>
                </div>
                
                <!-- B队区域 -->
                <div class="team-area team-b-area">
                    <div class="position pos-2" data-pos="2" data-team="B">
                        <div class="position-number">2号位</div>
                        <div>2</div>
                    </div>
                    <div class="position pos-3" data-pos="3" data-team="B">
                        <div class="position-number">3号位</div>
                        <div>3</div>
                    </div>
                    <div class="position pos-4" data-pos="4" data-team="B">
                        <div class="position-number">4号位</div>
                        <div>4</div>
                    </div>
                    <div class="position pos-1" data-pos="1" data-team="B">
                        <div class="position-number">1号位</div>
                        <div>1</div>
                    </div>
                    <div class="position pos-6" data-pos="6" data-team="B">
                        <div class="position-number">6号位</div>
                        <div>6</div>
                    </div>
                    <div class="position pos-5" data-pos="5" data-team="B">
                        <div class="position-number">5号位</div>
                        <div>5</div>
                    </div>
                </div>
            </div>
            
            <!-- 替补席区域 -->
            <div class="substitutes-area">
                <div class="team-substitutes team-a-subs">
                    <div class="substitute-title">A队替补席</div>
                    <div id="teamASubstitutesContainer"></div>
                </div>
                <div class="team-substitutes team-b-subs">
                    <div class="substitute-title">B队替补席</div>
                    <div id="teamBSubstitutesContainer"></div>
                </div>
            </div>
            
            <div class="score-display" id="scoreDisplay">0 - 0</div>
            
            <div class="control-buttons">
                <button class="team-a-btn" id="teamAScoreBtn">A队得分</button>
                <button class="team-b-btn" id="teamBScoreBtn">B队得分</button>
                <button class="pause-btn" id="pauseBtn">暂停</button>
                <button class="continue-btn" id="continueBtn" style="display: none;">继续比赛</button>
                <button class="substitute-btn" id="substituteBtn">换人</button>
                <button class="undo-btn" id="undoBtn">撤销上一步</button>
                <button class="return-btn" id="returnBtn">返回初始界面</button>
                <button class="history-btn" id="historyBtn">查看历史记录</button>
            </div>
            
            <div class="mini-history-panel" id="miniHistoryPanel">
                <div style="font-weight: bold; margin-bottom: 6px;">操作历史：</div>
                <div id="miniHistoryItems"></div>
            </div>
        </div>
        
        <div class="panel history-panel" id="historyPanel">
            <div class="history-header">
                <h2>完整历史记录</h2>
                <button class="back-btn" id="backBtn">返回比赛界面</button>
            </div>
            
            <div class="full-history-panel" id="fullHistoryPanel">
                <div id="fullHistoryItems"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM元素
            const setupPanel = document.getElementById('setupPanel');
            const gamePanel = document.getElementById('gamePanel');
            const historyPanel = document.getElementById('historyPanel');
            const confirmBtn = document.getElementById('confirmBtn');
            const returnBtn = document.getElementById('returnBtn');
            const historyBtn = document.getElementById('historyBtn');
            const backBtn = document.getElementById('backBtn');
            const serveTeamSelect = document.getElementById('serveTeam');
            const teamAPositions = document.querySelectorAll('.team-a-area .position');
            const teamBPositions = document.querySelectorAll('.team-b-area .position');
            const scoreDisplay = document.getElementById('scoreDisplay');
            const teamAScoreBtn = document.getElementById('teamAScoreBtn');
            const teamBScoreBtn = document.getElementById('teamBScoreBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const continueBtn = document.getElementById('continueBtn');
            const undoBtn = document.getElementById('undoBtn');
            const serveIndicator = document.getElementById('serveIndicator');
            const pauseIndicator = document.getElementById('pauseIndicator');
            const miniHistoryItems = document.getElementById('miniHistoryItems');
            const fullHistoryItems = document.getElementById('fullHistoryItems');
            const substituteBtn = document.getElementById('substituteBtn');
            const teamASubstitutesContainer = document.getElementById('teamASubstitutesContainer');
            const teamBSubstitutesContainer = document.getElementById('teamBSubstitutesContainer');
            
            // 存储初始设置
            let initialTeamAPlayers = {};
            let initialTeamBPlayers = {};
            let initialServeTeam = 'A';
            
            // 比赛数据
            let teamAPlayers = {1: '', 2: '', 3: '', 4: '', 5: '', 6: ''};
            let teamBPlayers = {1: '', 2: '', 3: '', 4: '', 5: '', 6: ''};
            let teamAPlayersOriginal = {1: '', 2: '', 3: '', 4: '', 5: '', 6: ''};
            let teamBPlayersOriginal = {1: '', 2: '', 3: '', 4: '', 5: '', 6: ''};
            let teamAScore = 0;
            let teamBScore = 0;
            let isTeamAServe = true;
            let lastServingTeam = null;
            let initialSetup = true;
            
            // 替补队员数据
            let teamASubstitutes = [];
            let teamBSubstitutes = [];
            
            // 暂停数据
            let pauseMode = false;
            let teamAPauses = 0;
            let teamBPauses = 0;
            let pauseTimer = null;
            
            // 换人数据
            let substitutionHistory = {
                'A': {1: null, 2: null, 3: null, 4: null, 5: null, 6: null},
                'B': {1: null, 2: null, 3: null, 4: null, 5: null, 6: null}
            };
            
            // 历史记录
            let history = [];
            
            // 更新替补席显示
            function updateSubstitutesDisplay() {
                // 清空现有替补显示
                teamASubstitutesContainer.innerHTML = '';
                teamBSubstitutesContainer.innerHTML = '';
                
                // 显示A队替补
                teamASubstitutes.forEach(sub => {
                    if (sub && sub.trim() !== '') {
                        const subEl = document.createElement('div');
                        subEl.className = 'substitute-player';
                        subEl.textContent = sub;
                        teamASubstitutesContainer.appendChild(subEl);
                    }
                });
                
                // 显示B队替补
                teamBSubstitutes.forEach(sub => {
                    if (sub && sub.trim() !== '') {
                        const subEl = document.createElement('div');
                        subEl.className = 'substitute-player';
                        subEl.textContent = sub;
                        teamBSubstitutesContainer.appendChild(subEl);
                    }
                });
            }
            
            // 获取当前发球球员
            function getServingPlayer() {
                return isTeamAServe ? 
                    `A队${teamAPlayers[1]}号` : 
                    `B队${teamBPlayers[1]}号`;
            }
            
            // 保存历史记录
            function saveState(action) {
                if (teamAScore > 0 || teamBScore > 0 || 
                    action === '比赛开始' || action.includes('暂停') || action.includes('换人')) {
                    const historyItem = {
                        teamAPlayers: {...teamAPlayers},
                        teamBPlayers: {...teamBPlayers},
                        teamAScore: teamAScore,
                        teamBScore: teamBScore,
                        isTeamAServe: isTeamAServe,
                        lastServingTeam: lastServingTeam,
                        initialSetup: initialSetup,
                        pauseMode: pauseMode,
                        teamAPauses: teamAPauses,
                        teamBPauses: teamBPauses,
                        servingPlayer: getServingPlayer(),
                        action: action || '操作',
                        substitutionHistory: JSON.parse(JSON.stringify(substitutionHistory)),
                        teamASubstitutes: [...teamASubstitutes],
                        teamBSubstitutes: [...teamBSubstitutes]
                    };
                    
                    // 如果是比赛开始，不记录发球方
                    if (action === '比赛开始') {
                        historyItem.servingPlayer = '初始发球方';
                    }
                    
                    history.push(historyItem);
                    updateHistory();
                }
            }
            
            // 更新历史记录显示
            function updateHistory() {
                updateMiniHistory();
                updateFullHistory();
            }
            
            // 迷你历史记录（最近5条）
            function updateMiniHistory() {
                miniHistoryItems.innerHTML = '';
                const recentHistory = history.slice(-5);
                
                recentHistory.forEach((item, index) => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    
                    const actionText = `${item.action} (A ${item.teamAScore}-${item.teamBScore} B)`;
                    
                    historyItem.innerHTML = `
                        <span>${history.length - recentHistory.length + index + 1}. ${actionText}</span>
                        ${item.action !== '比赛开始' ? `<span class="serve-team">发球: ${item.servingPlayer}</span>` : ''}
                    `;
                    
                    miniHistoryItems.appendChild(historyItem);
                });
            }
            
            // 完整历史记录
            function updateFullHistory() {
                fullHistoryItems.innerHTML = '';
                
                history.forEach((item, index) => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    
                    const actionText = `${item.action} (A ${item.teamAScore}-${item.teamBScore} B)`;
                    
                    historyItem.innerHTML = `
                        <span>${index + 1}. ${actionText}</span>
                        ${item.action !== '比赛开始' ? `<span class="serve-team">发球: ${item.servingPlayer}</span>` : ''}
                    `;
                    
                    fullHistoryItems.appendChild(historyItem);
                });
            }
            
            // 撤销上一步
            function undoLastAction() {
                if (history.length > 0) {
                    history.pop();
                    const prevState = history.length > 0 ? history[history.length - 1] : null;
                    
                    if (prevState) {
                        teamAPlayers = {...prevState.teamAPlayers};
                        teamBPlayers = {...prevState.teamBPlayers};
                        teamAScore = prevState.teamAScore;
                        teamBScore = prevState.teamBScore;
                        isTeamAServe = prevState.isTeamAServe;
                        lastServingTeam = prevState.lastServingTeam;
                        initialSetup = prevState.initialSetup;
                        pauseMode = prevState.pauseMode;
                        teamAPauses = prevState.teamAPauses;
                        teamBPauses = prevState.teamBPauses;
                        substitutionHistory = JSON.parse(JSON.stringify(prevState.substitutionHistory));
                        teamASubstitutes = [...prevState.teamASubstitutes];
                        teamBSubstitutes = [...prevState.teamBSubstitutes];
                    } else {
                        // 恢复到初始状态
                        teamAPlayers = {...initialTeamAPlayers};
                        teamBPlayers = {...initialTeamBPlayers};
                        teamAScore = 0;
                        teamBScore = 0;
                        isTeamAServe = initialServeTeam === 'A';
                        lastServingTeam = initialServeTeam;
                        initialSetup = true;
                        pauseMode = false;
                        teamAPauses = 0;
                        teamBPauses = 0;
                        substitutionHistory = {
                            'A': {1: null, 2: null, 3: null, 4: null, 5: null, 6: null},
                            'B': {1: null, 2: null, 3: null, 4: null, 5: null, 6: null}
                        };
                        teamASubstitutes = [...initialTeamAPlayers.sub];
                        teamBSubstitutes = [...initialTeamBPlayers.sub];
                    }
                    
                    updatePlayerDisplays();
                    updateSubstitutesDisplay();
                    updateScore();
                    updateServeIndicator();
                    updatePauseDisplay();
                    updateHistory();
                } else {
                    alert('没有可撤销的操作');
                }
            }
            
            // 返回初始界面
            function returnToSetup() {
                if (confirm('确定要返回初始界面吗？当前比赛数据将丢失。')) {
                    // 清除计时器
                    if (pauseTimer) {
                        clearInterval(pauseTimer);
                        pauseTimer = null;
                    }
                    
                    // 重置所有状态
                    history = [];
                    teamAPlayers = {1: '', 2: '', 3: '', 4: '', 5: '', 6: ''};
                    teamBPlayers = {1: '', 2: '', 3: '', 4: '', 5: '', 6: ''};
                    teamAPlayersOriginal = {1: '', 2: '', 3: '', 4: '', 5: '', 6: ''};
                    teamBPlayersOriginal = {1: '', 2: '', 3: '', 4: '', 5: '', 6: ''};
                    teamAScore = 0;
                    teamBScore = 0;
                    isTeamAServe = true;
                    lastServingTeam = null;
                    initialSetup = true;
                    pauseMode = false;
                    teamAPauses = 0;
                    teamBPauses = 0;
                    substitutionHistory = {
                        'A': {1: null, 2: null, 3: null, 4: null, 5: null, 6: null},
                        'B': {1: null, 2: null, 3: null, 4: null, 5: null, 6: null}
                    };
                    teamASubstitutes = [];
                    teamBSubstitutes = [];
                    
                    // 清空输入框
                    ['a-pos4','a-pos3','a-pos2','a-pos5','a-pos6','a-pos1',
                     'a-sub1','a-sub2','a-sub3','a-sub4','a-sub5','a-sub6',
                     'b-pos4','b-pos3','b-pos2','b-pos5','b-pos6','b-pos1',
                     'b-sub1','b-sub2','b-sub3','b-sub4','b-sub5','b-sub6'].forEach(id => {
                        document.getElementById(id).value = '';
                    });
                    
                    // 重置下拉选择
                    serveTeamSelect.value = 'A';
                    
                    // 切换显示面板
                    gamePanel.style.display = 'none';
                    setupPanel.style.display = 'block';
                    historyPanel.style.display = 'none';
                }
            }
            
            // 显示历史记录面板
            function showHistoryPanel() {
                gamePanel.style.display = 'none';
                historyPanel.style.display = 'block';
            }
            
            // 返回比赛界面
            function backToGamePanel() {
                historyPanel.style.display = 'none';
                gamePanel.style.display = 'block';
            }
            
            // 确认设置（初始化比赛）
            confirmBtn.addEventListener('click', function() {
                // 保存初始设置
                initialTeamAPlayers = {
                    4: document.getElementById('a-pos4').value || '4',
                    3: document.getElementById('a-pos3').value || '3',
                    2: document.getElementById('a-pos2').value || '2',
                    5: document.getElementById('a-pos5').value || '5',
                    6: document.getElementById('a-pos6').value || '6',
                    1: document.getElementById('a-pos1').value || '1'
                };
                
                initialTeamBPlayers = {
                    4: document.getElementById('b-pos4').value || '4',
                    3: document.getElementById('b-pos3').value || '3',
                    2: document.getElementById('b-pos2').value || '2',
                    5: document.getElementById('b-pos5').value || '5',
                    6: document.getElementById('b-pos6').value || '6',
                    1: document.getElementById('b-pos1').value || '1'
                };
                
                // 保存替补设置
                initialTeamAPlayers.sub = [
                    document.getElementById('a-sub1').value || '',
                    document.getElementById('a-sub2').value || '',
                    document.getElementById('a-sub3').value || '',
                    document.getElementById('a-sub4').value || '',
                    document.getElementById('a-sub5').value || '',
                    document.getElementById('a-sub6').value || ''
                ].filter(sub => sub.trim() !== '');
                
                initialTeamBPlayers.sub = [
                    document.getElementById('b-sub1').value || '',
                    document.getElementById('b-sub2').value || '',
                    document.getElementById('b-sub3').value || '',
                    document.getElementById('b-sub4').value || '',
                    document.getElementById('b-sub5').value || '',
                    document.getElementById('b-sub6').value || ''
                ].filter(sub => sub.trim() !== '');
                
                initialServeTeam = serveTeamSelect.value;
                
                // 初始化当前比赛数据
                teamAPlayers = {...initialTeamAPlayers};
                teamBPlayers = {...initialTeamBPlayers};
                teamAPlayersOriginal = {...initialTeamAPlayers};
                teamBPlayersOriginal = {...initialTeamBPlayers};
                isTeamAServe = initialServeTeam === 'A';
                lastServingTeam = initialServeTeam;
                initialSetup = true;
                teamAScore = 0;
                teamBScore = 0;
                pauseMode = false;
                teamAPauses = 0;
                teamBPauses = 0;
                
                // 初始化替补队员
                teamASubstitutes = [...initialTeamAPlayers.sub];
                teamBSubstitutes = [...initialTeamBPlayers.sub];
                
                // 初始化替换历史
                substitutionHistory = {
                    'A': {1: null, 2: null, 3: null, 4: null, 5: null, 6: null},
                    'B': {1: null, 2: null, 3: null, 4: null, 5: null, 6: null}
                };
                
                // 更新界面
                updatePlayerDisplays();
                updateSubstitutesDisplay();
                updateScore();
                updateServeIndicator();
                updatePauseDisplay();
                setupPanel.style.display = 'none';
                gamePanel.style.display = 'block';
                miniHistoryItems.innerHTML = '';
                fullHistoryItems.innerHTML = '';
                saveState('比赛开始');
            });
            
            // 得分按钮事件
            teamAScoreBtn.addEventListener('click', () => handleScore('A'));
            teamBScoreBtn.addEventListener('click', () => handleScore('B'));
            
            // 处理得分逻辑
            function handleScore(scoringTeam) {
                if (pauseMode) {
                    alert('比赛暂停中，无法计分');
                    return;
                }
                
                // 更新比分
                scoringTeam === 'A' ? teamAScore++ : teamBScore++;
                
                // 记录当前发球方
                const currentServingTeam = isTeamAServe ? 'A' : 'B';
                
                // 换发球条件：当前发球方≠得分方
                const isServeChange = currentServingTeam !== scoringTeam;
                
                // 轮转逻辑：换发球时，得分方进行逆时针轮转
                if (isServeChange) {
                    if (scoringTeam === 'A') {
                        rotateTeamACounterClockwise();
                    } else {
                        rotateTeamBCounterClockwise();
                    }
                }
                
                // 更新发球方
                isTeamAServe = scoringTeam === 'A';
                lastServingTeam = isTeamAServe ? 'A' : 'B';
                initialSetup = false;
                
                // 更新界面
                updateScore();
                updatePlayerDisplays();
                updateServeIndicator();
                saveState(`${scoringTeam}队得分`);
            }
            
            // A队逆时针轮转
            function rotateTeamACounterClockwise() {
                const temp = teamAPlayers[1];
                teamAPlayers[1] = teamAPlayers[2];
                teamAPlayers[2] = teamAPlayers[3];
                teamAPlayers[3] = teamAPlayers[4];
                teamAPlayers[4] = teamAPlayers[5];
                teamAPlayers[5] = teamAPlayers[6];
                teamAPlayers[6] = temp;
            }
            
            // B队逆时针轮转
            function rotateTeamBCounterClockwise() {
                const temp = teamBPlayers[1];
                teamBPlayers[1] = teamBPlayers[2];
                teamBPlayers[2] = teamBPlayers[3];
                teamBPlayers[3] = teamBPlayers[4];
                teamBPlayers[4] = teamBPlayers[5];
                teamBPlayers[5] = teamBPlayers[6];
                teamBPlayers[6] = temp;
            }
            
            // 更新队员显示
            function updatePlayerDisplays() {
                // 更新A队位置显示
                teamAPositions.forEach(position => {
                    const pos = position.getAttribute('data-pos');
                    position.querySelector('div:last-child').textContent = teamAPlayers[pos];
                });
                
                // 更新B队位置显示
                teamBPositions.forEach(position => {
                    const pos = position.getAttribute('data-pos');
                    position.querySelector('div:last-child').textContent = teamBPlayers[pos];
                });
            }
            
            // 更新比分显示
            function updateScore() {
                scoreDisplay.textContent = `${teamAScore} - ${teamBScore}`;
            }
            
            // 更新发球指示
            function updateServeIndicator() {
                serveIndicator.textContent = `当前发球方: ${isTeamAServe ? 'A队' + teamAPlayers[1] + '号' : 'B队' + teamBPlayers[1] + '号'}`;
            }
            
            // 暂停功能
            pauseBtn.addEventListener('click', function() {
                if (pauseMode) {
                    alert('比赛已处于暂停状态');
                    return;
                }
                
                // 创建暂停选择对话框
                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: white; padding: 15px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                    z-index: 100; min-width: 260px; text-align: center;
                `;
                dialog.innerHTML = `
                    <h3 style="margin: 0 0 10px 0; font-size: 16px;">申请暂停</h3>
                    <p style="margin: 0 0 15px 0; font-size: 14px;">请选择申请暂停的队伍（每队最多2次）</p>
                    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
                        <button id="pauseTeamA" style="background: var(--player-color); padding: 8px 15px; font-size: 13px;">A队暂停（已用${teamAPauses}/2次）</button>
                        <button id="pauseTeamB" style="background: var(--player-color); padding: 8px 15px; font-size: 13px;">B队暂停（已用${teamBPauses}/2次）</button>
                        <button id="cancelPause" style="background: #ccc; padding: 8px 15px; font-size: 13px;">取消</button>
                    </div>
                `;
                document.body.appendChild(dialog);
                
                // A队暂停
                document.getElementById('pauseTeamA').addEventListener('click', () => {
                    if (teamAPauses < 2) {
                        startPause('A');
                    } else {
                        alert('A队已用完2次暂停机会');
                    }
                    document.body.removeChild(dialog);
                });
                
                // B队暂停
                document.getElementById('pauseTeamB').addEventListener('click', () => {
                    if (teamBPauses < 2) {
                        startPause('B');
                    } else {
                        alert('B队已用完2次暂停机会');
                    }
                    document.body.removeChild(dialog);
                });
                
                // 取消暂停
                document.getElementById('cancelPause').addEventListener('click', () => {
                    document.body.removeChild(dialog);
                });
            });
            
            // 开始暂停
            function startPause(team) {
                pauseMode = true;
                team === 'A' ? teamAPauses++ : teamBPauses++;
                pauseIndicator.innerHTML = `${team}队第${team === 'A' ? teamAPauses : teamBPauses}次暂停 <span class="countdown">30</span>`;
                
                // 切换按钮显示
                pauseBtn.style.display = 'none';
                continueBtn.style.display = 'inline-block';
                
                // 30秒倒计时
                let seconds = 30;
                pauseTimer = setInterval(() => {
                    seconds--;
                    pauseIndicator.innerHTML = `${team}队第${team === 'A' ? teamAPauses : teamBPauses}次暂停 <span class="countdown">${seconds}</span>`;
                    
                    if (seconds <= 0) {
                        clearInterval(pauseTimer);
                        pauseTimer = null;
                        pauseIndicator.textContent = '暂停时间结束，请继续比赛';
                    }
                }, 1000);
                
                saveState(`${team}队请求暂停`);
            }
            
            // 继续比赛
            continueBtn.addEventListener('click', function() {
                if (!pauseMode) return;
                
                // 清除倒计时
                clearInterval(pauseTimer);
                pauseTimer = null;
                
                // 重置暂停状态
                pauseMode = false;
                pauseIndicator.textContent = '';
                
                // 切换按钮显示
                continueBtn.style.display = 'none';
                pauseBtn.style.display = 'inline-block';
                
                saveState('比赛继续');
            });
            
            // 更新暂停显示状态
            function updatePauseDisplay() {
                if (pauseMode) {
                    pauseBtn.style.display = 'none';
                    continueBtn.style.display = 'inline-block';
                } else {
                    pauseBtn.style.display = 'inline-block';
                    continueBtn.style.display = 'none';
                }
            }
            
            // 换人功能
            substituteBtn.addEventListener('click', function() {
                if (pauseMode) {
                    alert('比赛暂停中，无法换人');
                    return;
                }
                
                // 创建换人选择对话框
                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: white; padding: 15px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                    z-index: 100; min-width: 260px; text-align: center;
                `;
                dialog.innerHTML = `
                    <h3 style="margin: 0 0 10px 0; font-size: 16px;">换人操作</h3>
                    <p style="margin: 0 0 15px 0; font-size: 14px;">请选择要换人的队伍</p>
                    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
                        <button id="substituteTeamA" style="background: var(--player-color); padding: 8px 15px; font-size: 13px;">A队换人</button>
                        <button id="substituteTeamB" style="background: var(--player-color); padding: 8px 15px; font-size: 13px;">B队换人</button>
                        <button id="cancelSubstitute" style="background: #ccc; padding: 8px 15px; font-size: 13px;">取消</button>
                    </div>
                `;
                document.body.appendChild(dialog);
                
                // A队换人
                document.getElementById('substituteTeamA').addEventListener('click', () => {
                    document.body.removeChild(dialog);
                    showSubstituteDialog('A');
                });
                
                // B队换人
                document.getElementById('substituteTeamB').addEventListener('click', () => {
                    document.body.removeChild(dialog);
                    showSubstituteDialog('B');
                });
                
                // 取消换人
                document.getElementById('cancelSubstitute').addEventListener('click', () => {
                    document.body.removeChild(dialog);
                });
            });
            
            // 显示换人对话框
            function showSubstituteDialog(team) {
                const teamPlayers = team === 'A' ? teamAPlayers : teamBPlayers;
                const teamSubs = team === 'A' ? teamASubstitutes : teamBSubstitutes;
                
                // 检查是否有可用的替补
                if (teamSubs.length === 0) {
                    alert(`${team}队没有可用的替补队员`);
                    return;
                }

                // 创建换人对话框
                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: white; padding: 15px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                    z-index: 100; min-width: 300px;
                `;
                
                // 构建对话框内容
                let dialogContent = `
                    <h3 style="margin: 0 0 10px 0; font-size: 16px;">${team}队换人</h3>
                    <div style="margin-bottom: 12px;">
                        <label for="substitutePosition" style="font-size: 14px;">选择位置:</label>
                        <select id="substitutePosition" style="margin-left: 8px; font-size: 13px;">
                            <option value="1">1号位 (当前: ${teamPlayers[1]}号)</option>
                            <option value="2">2号位 (当前: ${teamPlayers[2]}号)</option>
                            <option value="3">3号位 (当前: ${teamPlayers[3]}号)</option>
                            <option value="4">4号位 (当前: ${teamPlayers[4]}号)</option>
                            <option value="5">5号位 (当前: ${teamPlayers[5]}号)</option>
                            <option value="6">6号位 (当前: ${teamPlayers[6]}号)</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="substitutePlayer" style="font-size: 14px;">替补队员:</label>
                        <select id="substitutePlayer" style="margin-left: 8px; font-size: 13px;">
                            ${teamSubs.map(sub => `<option value="${sub}">${sub}号</option>`).join('')}
                        </select>
                    </div>
                    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
                        <button id="confirmSubstitute" style="background: var(--button-primary); padding: 8px 15px; font-size: 13px;">确认换人</button>
                        <button id="cancelSubstitute" style="background: #ccc; padding: 8px 15px; font-size: 13px;">取消</button>
                    </div>
                `;
                
                dialog.innerHTML = dialogContent;
                document.body.appendChild(dialog);
                
                // 确认换人
                document.getElementById('confirmSubstitute').addEventListener('click', function() {
                    const position = document.getElementById('substitutePosition').value;
                    const playerIn = document.getElementById('substitutePlayer').value;
                    const playerOut = teamPlayers[position];
                    
                    // 执行换人
                    const substituteIndex = teamSubs.indexOf(playerIn);
                    if (substituteIndex !== -1) {
                        // 从替补席移除新上场球员
                        teamSubs.splice(substituteIndex, 1);
                        
                        // 将下场球员加入替补席
                        teamSubs.push(playerOut);
                        
                        // 更新场上球员
                        teamPlayers[position] = playerIn;
                        
                        // 记录替换历史
                        substitutionHistory[team][position] = {
                            playerIn: playerIn,
                            playerOut: playerOut
                        };
                        
                        // 更新界面
                        updatePlayerDisplays();
                        updateSubstitutesDisplay();
                        updateHistory();
                        saveState(`${team}队换人: ${position}号位 ${playerOut}号→${playerIn}号`);
                    }
                    
                    document.body.removeChild(dialog);
                });
                
                // 取消换人
                document.getElementById('cancelSubstitute').addEventListener('click', function() {
                    document.body.removeChild(dialog);
                });
            }

            // 绑定其他按钮事件
            returnBtn.addEventListener('click', returnToSetup);
            historyBtn.addEventListener('click', showHistoryPanel);
            backBtn.addEventListener('click', backToGamePanel);
            undoBtn.addEventListener('click', undoLastAction);
            
            // 初始化显示
            updatePlayerDisplays();
            updateSubstitutesDisplay();
            updateScore();
            updateServeIndicator();
            updatePauseDisplay();
        });
    </script>
</body>
</html>